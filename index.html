<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UNOPAR CRM Dashboard - Unidade Recife</title>
    <style>
        /* DEFINIÇÃO DE CORES UNOPAR */
        :root {
            --unopar-blue-dark: #1E3799; /* Azul Principal Forte */
            --unopar-orange-accent: #FF8F00; /* Laranja/Amarelo de Destaque */
            --background-light: #f0f2f5;
            --text-dark: #343a40;
            --success-green: #28a745;
            --danger-red: #dc3545;
        }

        /* RESET & BASE */
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background-light);
            margin: 0;
            padding: 0;
            overflow-y: hidden; 
        }
        .dashboard-container {
            max-width: 1300px;
            margin: 20px auto; 
            padding: 10px 20px;
            height: calc(100vh - 40px);
            overflow-y: auto; 
            box-sizing: border-box;
        }

        /* HEADER & LOGO ALINHAMENTO */
        .main-header {
            display: flex; 
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 3px solid var(--unopar-orange-accent); /* Linha de acento UNOPAR */
            padding-bottom: 5px;
        }
        .main-header h1 {
            color: var(--unopar-blue-dark);
            font-weight: 700;
            margin: 0; 
            font-size: 1.8em;
        }
        /* ESTILO PARA LOGO SVG "U" */
        .logo-svg {
            height: 40px; 
            width: 40px;
            margin-right: 15px; 
        }
        .logo-svg .u-blue {
            fill: var(--unopar-blue-dark);
        }
        .logo-svg .u-orange {
            fill: var(--unopar-orange-accent);
        }

        /* FILTROS E CONFIGURAÇÕES */
        .header-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap; /* Responsividade básica */
            gap: 15px;
        }
        .date-filter-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .date-filter-group label {
            font-weight: 500;
            color: var(--text-dark);
        }
        .date-filter-group input {
            padding: 8px;
            border: 1px solid #ced4da;
            border-radius: 6px;
        }
        /* Botão de Filtro - AZUL UNOPAR */
        .btn-filter, .btn-config, .form-submit-btn, .btn-insert {
            padding: 8px 15px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.3s, box-shadow 0.3s;
            font-weight: 600;
        }
        .btn-filter {
            background-color: var(--unopar-blue-dark);
            color: white;
        }
        .btn-filter:hover:not(:disabled) { background-color: #1a2e7a; }
        .btn-filter:disabled { background-color: #a0a0a0; cursor: not-allowed; }

        /* Botão de Configuração - Cinza Profissional */
        .btn-config {
            background-color: #6c757d; 
            color: white;
            padding: 10px 20px;
        }
        .btn-config:hover:not(:disabled) { background-color: #5a6268; }
        
        h2.group-title {
            color: var(--text-dark);
            font-size: 1.2em;
            margin-top: 20px;
            margin-bottom: 10px;
            border-left: 4px solid var(--unopar-orange-accent); /* Destaque Laranja */
            padding-left: 10px;
        }

        /* KPIs */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px; 
            margin-bottom: 20px;
        }
        .kpi-card {
            background: #ffffff;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            min-height: 80px; /* Garante tamanho mínimo */
        }
        .kpi-value {
            font-size: 2.2em;
            font-weight: 700;
            color: var(--unopar-blue-dark); 
            margin-bottom: 2px;
        }
        .kpi-label {
            font-size: 0.85em;
            color: #6c757d;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        /* Bordas dos KPIs */
        .kpi-card-ativos { border-left: 4px solid var(--unopar-blue-dark); }
        .kpi-card-meta-mat { border-left: 4px solid var(--success-green); } 
        .kpi-card-meta-remat { border-left: 4px solid var(--unopar-orange-accent); } 
        .kpi-card-progresso { 
            background-color: #e9f5e9; 
            border-left: 4px solid #17a2b8; /* Cor de progresso */
            position: relative;
            overflow: hidden;
        }
        /* Barra de progresso visual */
        .progress-bar-overlay {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            width: 0%; /* Controlado pelo JS */
            background: linear-gradient(90deg, #17a2b840, transparent);
            z-index: 1;
            transition: width 0.5s ease-out;
        }
        .kpi-card-progresso .kpi-value,
        .kpi-card-progresso .kpi-label {
            position: relative;
            z-index: 2; /* Garante que o texto fique acima da barra */
        }
        .kpi-card-ativos, .kpi-card-meta-mat, .kpi-card-meta-remat {
            border-radius: 8px; /* Aplica o arredondamento para todos */
        }

        /* GRÁFICOS */
        .chart-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); 
            gap: 15px;
            margin-bottom: 20px;
        }
        .chart-placeholder {
            background-color: #ffffff;
            height: 250px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-weight: 500;
            color: #333;
            padding: 15px;
            border-bottom: 4px solid var(--unopar-blue-dark);
            text-align: center; /* Centraliza texto em telas pequenas */
        }
        .chart-placeholder h3 { font-size: 1.2em; margin: 0; padding: 0; color: var(--unopar-blue-dark); }
        .chart-placeholder p { font-size: 0.9em; color: #6c757d; margin-top: 5px; }

        /* BOTÃO FLUTUANTE */
        .btn-insert {
            position: fixed;
            bottom: 20px; 
            right: 20px; 
            background-color: var(--unopar-orange-accent); 
            color: var(--unopar-blue-dark); 
            padding: 15px 30px;
            font-size: 1.1em;
            font-weight: 700; 
            box-shadow: 0 4px 12px rgba(255, 143, 0, 0.5);
            z-index: 50;
        }
        .btn-insert:hover:not(:disabled) {
            background-color: #e58100;
            box-shadow: 0 6px 15px rgba(255, 143, 0, 0.6);
        }
        .btn-insert:disabled { background-color: #a0a0a0; cursor: not-allowed; box-shadow: none; }

        /* MODAIS */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.6);
            backdrop-filter: blur(3px); 
            overflow-y: auto; 
        }
        .modal-content {
            background-color: #ffffff;
            margin: 5% auto; 
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 600px; 
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.2); 
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-title {
            color: var(--unopar-blue-dark);
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        .form-group-section-simple {
            display: grid;
            grid-template-columns: 1fr 1fr; 
            gap: 15px 30px; 
            margin-bottom: 20px;
        }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 500; color: var(--text-dark); }
        .form-group input, .form-group select {
            width: 100%;
            padding: 10px; 
            border: 1px solid #ced4da;
            border-radius: 6px;
            box-sizing: border-box;
            transition: border-color 0.2s;
        }
        .form-group input:focus, .form-group select:focus { border-color: var(--unopar-blue-dark); outline: none; box-shadow: 0 0 0 0.2rem rgba(30, 55, 153, 0.25); }
        
        .form-submit-btn {
            background-color: var(--unopar-blue-dark);
            color: white;
            padding: 12px;
            font-size: 1em;
            width: 100%;
            margin-top: 20px;
        }
        .form-submit-btn:hover:not(:disabled) { background-color: #1a2e7a; }
        .form-submit-btn:disabled { background-color: #a0a0a0; cursor: not-allowed; }
        
        .close-btn { color: #aaa; float: right; font-size: 32px; font-weight: normal; transition: color 0.2s; cursor: pointer; }
        .close-btn:hover { color: #555; }

        /* TOAST NOTIFICATION STYLES */
        #toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 2000;
        }
        .toast {
            background-color: #333;
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 10px;
            opacity: 0;
            transition: opacity 0.5s, transform 0.5s;
            transform: translateX(100%);
            min-width: 250px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
        }
        .toast.show {
            opacity: 1;
            transform: translateX(0);
        }
        .toast-icon {
            margin-right: 10px;
            font-size: 1.2em;
        }
        .toast.success { background-color: var(--success-green); }
        .toast.error { background-color: var(--danger-red); }
        .toast.info { background-color: var(--unopar-blue-dark); }

        /* Responsiveness */
        @media (max-width: 768px) {
            .dashboard-container {
                padding: 10px;
                margin: 10px auto;
            }
            .main-header h1 {
                font-size: 1.4em;
            }
            .header-controls {
                flex-direction: column;
                align-items: flex-start;
            }
            .date-filter-group {
                width: 100%;
                flex-wrap: wrap;
            }
            .kpi-grid, .chart-section {
                grid-template-columns: 1fr;
            }
            .form-group-section-simple {
                grid-template-columns: 1fr;
            }
            .btn-insert {
                bottom: 10px;
                right: 10px;
                padding: 10px 20px;
                font-size: 1em;
            }
        }
    </style>
</head>
<body>

<div id="toast-container"></div>

<div class="dashboard-container">
    
    <div class="main-header">
        <svg class="logo-svg" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg">
            <!-- SVG UNOPAR (Adaptado) -->
            <path class="u-blue" d="M375.3 128C375.3 57.31 317.9 0 247.3 0H136.7C66.1 0 8.7 57.31 8.7 128V375.3C8.7 445.9 66.1 503.3 136.7 503.3H375.3C445.9 503.3 503.3 445.9 503.3 375.3V128H375.3Z"/>
            <path class="u-orange" d="M136.7 375.3V128H247.3C317.9 128 375.3 185.3 375.3 256V375.3C375.3 445.9 317.9 503.3 247.3 503.3H136.7C66.1 503.3 8.7 445.9 8.7 375.3H136.7Z"/>
        </svg>
        <h1>CRM Operacional - Unidade Recife <span style="font-size: 0.7em; color: #6c757d;" id="current-user-id"></span></h1>
    </div>

    <div class="header-controls">
        <div class="date-filter-group">
            <label for="data-filtro">Buscar Registro por Data:</label>
            <input type="date" id="data-filtro">
            <button id="btn-filtrar" class="btn-filter" disabled>Filtrar</button>
        </div>
        <button id="openConfigBtn" class="btn-config" disabled>⚙️ Configurações de Metas</button>
    </div>

    <div class="kpi-grid">
        <div class="kpi-card kpi-card-ativos">
            <div class="kpi-value" id="kpi-ativos">0</div>
            <div class="kpi-label">Total de Alunos Ativos</div>
        </div>
        <div class="kpi-card kpi-card-meta-mat">
            <div class="kpi-value" id="kpi-meta-mat">400</div>
            <div class="kpi-label">META MATRÍCULA</div>
        </div>
        <div class="kpi-card kpi-card-meta-remat">
            <div class="kpi-value" id="kpi-meta-remat">773</div>
            <div class="kpi-label">META REMATRÍCULA</div>
        </div>
        <div class="kpi-card kpi-card-progresso">
            <div class="progress-bar-overlay" id="progresso-bar" style="width: 0%;"></div>
            <div class="kpi-value" id="kpi-progresso">0%</div>
            <div class="kpi-label">Progresso da Meta Total</div>
        </div>
    </div>

    <h2 class="group-title">Análise Detalhada (Último Registro)</h2>
    <div class="chart-section">
        
        <div class="chart-placeholder">
            <h3 id="chart-financeiro-adimplentes">N/A Adimplentes</h3>
            <p>Situação Financeira (Adimplentes / Inadimplentes)</p>
        </div>
        
        <div class="chart-placeholder">
            <h3 id="chart-documentacao-regular">N/A Regulares</h3>
            <p>Documentação (Regular / Irregular)</p>
        </div>
        
        <div class="chart-placeholder">
            <h3 id="chart-modalidade-semi">N/A Semipresencial</h3>
            <p>Modalidade (Semipresencial / Online)</p>
        </div>
        
        <div class="chart-placeholder">
            <h3 id="chart-evasao-trancada">N/A Trancadas</h3>
            <p>Evasão (Trancada, Cancelada, Não Efetivação)</p>
        </div>

        <div class="chart-placeholder">
            <h3 id="chart-data-registro">Data: Não Registrado</h3>
            <p>Último Registro de Dados</p>
        </div>

        <div class="chart-placeholder">
            <h3 id="chart-status-ativos">N/A Status</h3>
            <p>Status de Ativos (ATH, Calouros, Formandos)</p>
        </div>
    </div>
</div>

<button class="btn-insert" id="openModalBtn" disabled>➕ Inserir Dados Diários</button>

<div id="dataModal" class="modal">
    <div class="modal-content">
        <span class="close-btn data-close-btn">&times;</span>
        <h2 class="form-title">Registro Diário de Métricas</h2>
        <form id="dataForm">
            <div class="form-group-section-simple">
                <!-- Coluna 1 -->
                <div style="grid-column: 1 / 2;">
                    <div class="form-group">
                        <label for="input-data-display">Data do Registro</label>
                        <input type="text" id="input-data-display" name="data_display" readonly>
                        <input type="hidden" id="input-data-firestore" name="data_firestore">
                    </div>
                    <!-- Financeiro -->
                    <div class="form-group">
                        <label for="input-adimplente">ADIMPLEMTE</label>
                        <input type="number" id="input-adimplente" name="adimplente" value="0" min="0" required>
                    </div>
                    <div class="form-group">
                        <label for="input-inadimplente">INADIMPLENTE</label>
                        <input type="number" id="input-inadimplente" name="inadimplente" value="0" min="0" required>
                    </div>
                    <!-- Status do Aluno -->
                    <div class="form-group">
                        <label for="input-ativa">ATIVA</label>
                        <input type="number" id="input-ativa" name="ativa" value="0" min="0" required>
                    </div>
                    <div class="form-group">
                        <label for="input-formando">FORMANDO</label>
                        <input type="number" id="input-formando" name="formando" value="0" min="0" required>
                    </div>
                    <div class="form-group">
                        <label for="input-ath-calouros">ATH/calouros</label>
                        <input type="number" id="input-ath-calouros" name="ath_calouros" value="0" min="0" required>
                    </div>
                    <div class="form-group">
                        <label for="input-ath-veterano">ATH/Veterano</label>
                        <input type="number" id="input-ath-veterano" name="ath_veterano" value="0" min="0" required>
                    </div>
                </div>

                <!-- Coluna 2 -->
                <div style="grid-column: 2 / 3;">
                    <!-- Documentação -->
                    <div class="form-group">
                        <label for="input-doc-reg">DOC REGULAR</label>
                        <input type="number" id="input-doc-reg" name="doc_regular" value="0" min="0" required>
                    </div>
                    <div class="form-group">
                        <label for="input-doc-irre">DOC IRREGULAR</label>
                        <input type="number" id="input-doc-irre" name="doc_irre" value="0" min="0" required>
                    </div>
                    <!-- Modalidade -->
                    <div class="form-group">
                        <label for="input-semipresencial">SEMIPRESENCIAL</label>
                        <input type="number" id="input-semipresencial" name="semipresencial" value="0" min="0" required>
                    </div>
                    <div class="form-group">
                        <label for="input-100-online">100% ONLINE</label>
                        <input type="number" id="input-100-online" name="online_100" value="0" min="0" required>
                    </div>
                    <!-- Evasão/Não Efetivação -->
                    <div class="form-group">
                        <label for="input-trancada">TRANCADA</label>
                        <input type="number" id="input-trancada" name="trancada" value="0" min="0" required>
                    </div>
                    <div class="form-group">
                        <label for="input-cancelada">CANCELADA</label>
                        <input type="number" id="input-cancelada" name="cancelada" value="0" min="0" required>
                    </div>
                    <div class="form-group">
                        <label for="input-nao-efet">NÃO EFET. MATRÍCULA</label>
                        <input type="number" id="input-nao-efet" name="nao_efet_mat" value="0" min="0" required>
                    </div>
                    <div class="form-group">
                        <label for="input-calouro-ext">CALOURO/ext</label>
                        <input type="number" id="input-calouro-ext" name="calouro_ext" value="0" min="0" required>
                    </div>
                </div>
            </div>
            
            <button type="submit" class="form-submit-btn" id="saveDataBtn">Salvar Registro</button>
        </form>
    </div>
</div>

<div id="configModal" class="modal">
    <div class="modal-content" style="max-width: 400px; margin: 10% auto;">
        <span class="close-btn config-close-btn">&times;</span>
        <h2 class="form-title">Configuração de Metas</h2>
        <form id="configForm">
            <div class="form-group">
                <label for="config-meta-mat">Meta Matrícula</label>
                <input type="number" id="config-meta-mat" name="meta_matricula" min="0" required>
            </div>
            <div class="form-group">
                <label for="config-meta-remat">Meta Rematrícula</label>
                <input type="number" id="config-meta-remat" name="meta_rematricula" min="0" required>
            </div>
            <div class="form-group">
                <label for="config-meta-total">Meta Total (Calculado automaticamente)</label>
                <input type="number" id="config-meta-total" name="meta_total" min="0" readonly>
            </div>
            <button type="submit" class="form-submit-btn" id="saveConfigBtn">Salvar Configuração</button>
        </form>
    </div>
</div>

<script type="module">
    // === 1. IMPORTS DO FIREBASE ===
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, onSnapshot, collection, query, limit, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Ativar logs do Firebase para debug (Obrigatório em ambientes Canvas)
    setLogLevel('Debug');

    // === 2. VARIÁVEIS GLOBAIS DO CANVAS & FIREBASE ===
    let db;
    let auth;
    let userId = null;
    let isAuthReady = false;

    // Variáveis injetadas pelo ambiente (Canvas/Teams)
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    // Credenciais de FALLBACK (Genéricas e Seguras para Autenticação Anônima/Token)
    // Usamos o appId dinamicamente para o projectId
    const FALLBACK_CONFIG = {
        apiKey: "AIzaSyC0L0Gic-Fallback-KEY-Do-Not-USE-In-Prod", // Chave genérica.
        authDomain: `${appId}.firebaseapp.com`,
        projectId: appId, 
        storageBucket: `${appId}.appspot.com`,
        messagingSenderId: "123456789012",
        appId: "1:123456789012:web:a1b2c3d4e5f6g7h8i9j0"
    };

    let firebaseConfig = FALLBACK_CONFIG; // Começa sempre com o fallback
    const DEBUG_FIREBASE_CONFIG_STATUS = typeof __firebase_config !== 'undefined' ? __firebase_config : 'INDEFINIDO';

    // Tenta obter e parsear a configuração real do Firebase, se disponível.
    try {
        if (typeof __firebase_config !== 'undefined' && __firebase_config) {
            const injectedConfig = JSON.parse(__firebase_config);
            // Sobrescreve SÓ SE a configuração injetada for válida
            if (injectedConfig.apiKey && injectedConfig.projectId) {
                firebaseConfig = injectedConfig;
                console.log("SUCESSO: Usando Configuração do Firebase Injetada.");
            } else {
                 console.warn("ALERTA: Configuração injetada, mas incompleta. Usando Fallback.");
            }
        } else {
            console.warn("ALERTA: Configuração do Firebase não injetada. Usando Fallback.");
        }
    } catch (e) {
        console.error("ERRO CRÍTICO: Falha ao decodificar __firebase_config. Usando Fallback.", e);
    }
    
    // Caminhos Firestore
    const CONFIG_DOC_PATH = (uid) => `artifacts/${appId}/users/${uid}/config/metas`;
    const DAILY_COLLECTION_PATH = (uid) => `artifacts/${appId}/users/${uid}/registros_diarios`;

    // Metas em memória
    let metasConfig = {
        meta_matricula: 400,
        meta_rematricula: 773,
        meta_total: 1173
    };

    // Dados do último registro em memória
    let ultimoRegistro = null;


    // === 3. FUNÇÕES DE UTILIDADE E UI ===

    /**
     * Função para exibir notificações Toast.
     * @param {string} message - A mensagem a ser exibida.
     * @param {'success'|'error'|'info'} type - O tipo de notificação.
     */
    function showNotification(message, type = 'info') {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        
        let icon = '';
        if (type === 'success') icon = '✅';
        else if (type === 'error') icon = '❌';
        else icon = 'ℹ️';

        toast.innerHTML = `<span class="toast-icon">${icon}</span> ${message}`;
        container.appendChild(toast);

        setTimeout(() => {
            toast.classList.add('show');
        }, 10); // Pequeno atraso para garantir a transição

        setTimeout(() => {
            toast.classList.remove('show');
            toast.addEventListener('transitionend', () => toast.remove());
        }, 5000);
    }

    /**
     * Formata a data de Date object para YYYY-MM-DD (Firestore ID).
     * @param {Date} date - Objeto Date.
     * @returns {string} - Data formatada (YYYY-MM-DD).
     */
    function formatDateID(date) {
        const yyyy = date.getFullYear();
        const mm = String(date.getMonth() + 1).padStart(2, '0');
        const dd = String(date.getDate()).padStart(2, '0');
        return `${yyyy}-${mm}-${dd}`;
    }

    /**
     * Formata a data de Date object para DD/MM/YYYY (Display UI).
     * @param {Date} date - Objeto Date.
     * @returns {string} - Data formatada (DD/MM/YYYY).
     */
    function formatDateDisplay(date) {
        const yyyy = date.getFullYear();
        const mm = String(date.getMonth() + 1).padStart(2, '0');
        const dd = String(date.getDate()).padStart(2, '0');
        return `${dd}/${mm}/${yyyy}`;
    }

    /**
     * Função para habilitar/desabilitar os botões interativos
     * @param {boolean} enabled - true para habilitar, false para desabilitar
     */
    function setControlsEnabled(enabled) {
        document.getElementById('openModalBtn').disabled = !enabled;
        document.getElementById('openConfigBtn').disabled = !enabled;
        document.getElementById('btn-filtrar').disabled = !enabled;
    }


    // === 4. INICIALIZAÇÃO DO FIREBASE & AUTENTICAÇÃO ===
    async function initializeFirebase() {
        
        // Desabilita botões preventivamente
        setControlsEnabled(false);

        // 1. LINHA DE DEBUG (MANTIDA)
        console.error("DEBUG: Conteúdo de __firebase_config (se presente):", DEBUG_FIREBASE_CONFIG_STATUS);

        // 2. VERIFICAÇÃO CRÍTICA DA CONFIGURAÇÃO 
        if (!firebaseConfig.apiKey || !firebaseConfig.projectId) {
            console.error("ERRO FATAL: A configuração do Firebase está incompleta ou inválida, mesmo após o fallback.");
            showNotification("ERRO FATAL: Configuração do Firebase ausente/inválida. App desativado.", 'error');
            return;
        }

        try {
            // 3. Inicializa o App
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            // 4. Tenta fazer login com o token personalizado ou anonimamente
            const userCredential = initialAuthToken
                ? await signInWithCustomToken(auth, initialAuthToken)
                : await signInAnonymously(auth);

            if (userCredential && userCredential.user) {
                // Autenticação bem sucedida
                userId = userCredential.user.uid;
                isAuthReady = true;
                console.log("Firebase Auth e Firestore prontos. User ID:", userId);
                document.getElementById('current-user-id').textContent = `(ID: ${userId})`;
                
                // Habilitar botões após a autenticação BEM SUCEDIDA
                setControlsEnabled(true);
                
                // 5. Inicia os listeners de dados
                startFirestoreListeners(userId);
                showNotification("Conexão ao Firebase estabelecida com sucesso!", 'success');
            } else {
                console.error("Erro na autenticação. Usuário não encontrado.");
                showNotification("Erro na autenticação do Firebase. Recarregue a página.", 'error');
            }

        } catch (error) {
            // Captura erros comuns de inicialização/autenticação
            console.error("Erro ao inicializar Firebase ou Autenticar:", error);
            const errorCode = error.code ? `Firebase: ${error.code}` : "Verifique as configurações do projeto.";
            showNotification(`Falha na Inicialização: ${errorCode}. App desativado.`, 'error');
            setControlsEnabled(false); // Garante que fiquem desabilitados
        }
    }


    // === 5. LISTENERS DO FIRESTORE (TEMPO REAL) ===

    function startFirestoreListeners(uid) {
        // --- Listener 1: Metas (Configurações) ---
        onSnapshot(doc(db, CONFIG_DOC_PATH(uid)), (docSnapshot) => {
            if (docSnapshot.exists()) {
                const newMetas = docSnapshot.data();
                metasConfig = {
                    // Usando 0 como fallback para garantir que sejam números
                    meta_matricula: Number(newMetas.meta_matricula) || 0,
                    meta_rematricula: Number(newMetas.meta_rematricula) || 0
                };
                metasConfig.meta_total = metasConfig.meta_matricula + metasConfig.meta_rematricula;
                
                // Atualiza KPIs de Meta na tela
                document.getElementById("kpi-meta-mat").textContent = metasConfig.meta_matricula;
                document.getElementById("kpi-meta-remat").textContent = metasConfig.meta_rematricula;

                // Recarrega dashboard com a nova meta e o último registro
                carregarDadosNaTela(ultimoRegistro);
            } else {
                console.log("Documento de Metas não encontrado. Usando padrões e salvando...");
                // Se não existir, salva o padrão inicial
                setDoc(doc(db, CONFIG_DOC_PATH(uid)), metasConfig, { merge: true }).catch(e => console.error("Erro ao salvar metas padrão:", e));
            }
        }, (error) => {
            console.error("Erro no Listener de Metas:", error);
            if (error.code === 'permission-denied') {
                showNotification("ERRO CRÍTICO: Permissão Negada para ler Metas. Verifique suas Regras.", 'error');
            } else {
                showNotification("Erro ao sincronizar Metas (Rede ou Acesso).", 'error');
            }
        });

        // --- Listener 2: Último Registro Diário ---
        // ATENÇÃO: Firestore não suporta 'orderBy' por padrão sem índices em tempo de execução.
        // O código original usava orderBy("data_id", "desc") e limit(1).
        // Para evitar erros de índice, vamos manter o código, mas o cliente deve estar ciente
        // de que, se houver muitos documentos, o orderBy pode falhar.
        // Já que data_id é YYYY-MM-DD, a ordenação alfabética funciona como ordenação cronológica.
        const q = query(
            collection(db, DAILY_COLLECTION_PATH(uid)),
            orderBy("data_id", "desc"), // Mantido o orderBy, mas ciente do risco de índice ausente.
            limit(1)
        );

        onSnapshot(q, (snapshot) => {
            if (!snapshot.empty) {
                const latestDoc = snapshot.docs[0];
                ultimoRegistro = latestDoc.data();
                carregarDadosNaTela(ultimoRegistro);
            } else {
                ultimoRegistro = null;
                carregarDadosNaTela(null);
                document.getElementById("chart-data-registro").textContent = 'Data: Nenhum Registro';
            }
        }, (error) => {
            console.error("Erro no Listener de Registros Diários:", error);
            if (error.code === 'permission-denied') {
                showNotification("ERRO CRÍTICO: Permissão Negada para ler Registros. Verifique suas Regras.", 'error');
            } else {
                showNotification("Erro ao sincronizar Registros Diários (Rede ou Acesso).", 'error');
            }
        });
    }

    // === 6. FUNÇÃO PRINCIPAL DE RENDERIZAÇÃO ===

    function carregarDadosNaTela(dados) {
        let totalAtivos = 0;
        let progresso = 0;
        const progressoBar = document.getElementById('progresso-bar');

        if (dados) {
            // 1. SOMA TOTAL DE ATIVOS E VALIDAÇÃO DE NÚMEROS
            const getNum = (key) => Number(dados[key]) || 0;

            const ativa = getNum('ativa');
            const formando = getNum('formando');
            const ath_calouros = getNum('ath_calouros');
            const ath_veterano = getNum('ath_veterano');
            const calouro_ext = getNum('calouro_ext');

            totalAtivos = ativa + formando + ath_calouros + ath_veterano + calouro_ext;
            
            // 2. CÁLCULO DE PROGRESSO (USANDO meta_total em memória)
            if (metasConfig.meta_total > 0) {
                progresso = Math.round((totalAtivos / metasConfig.meta_total) * 100);
            }
            
            // 3. ATUALIZAR GRÁFICOS DETALHADOS
            const adimplentes = getNum('adimplente');
            const inadimplentes = getNum('inadimplente');
            const doc_regular = getNum('doc_regular');
            const doc_irre = getNum('doc_irre');
            const semipresencial = getNum('semipresencial');
            const online_100 = getNum('online_100');
            const trancada = getNum('trancada');
            const cancelada = getNum('cancelada');
            const nao_efet_mat = getNum('nao_efet_mat');

            document.getElementById("chart-financeiro-adimplentes").textContent = `${adimplentes} Adimplentes | ${inadimplentes} Inadimplentes`;
            document.getElementById("chart-documentacao-regular").textContent = `${doc_regular} Regulares | ${doc_irre} Irregulares`;
            document.getElementById("chart-modalidade-semi").textContent = `${semipresencial} Semi | ${online_100} Online`;
            
            const totalEvasao = trancada + cancelada + nao_efet_mat;
            document.getElementById("chart-evasao-trancada").textContent = `${totalEvasao} Evasão | T:${trancada} C:${cancelada}`;
            
            document.getElementById("chart-data-registro").textContent = `Data: ${dados.data_display}`;
            
            document.getElementById("chart-status-ativos").textContent = `ATH:${ath_calouros + ath_veterano} | Ativa:${ativa} | Formando:${formando}`;

        } else {
            // Se não houver dados, zera as visualizações
            document.getElementById("chart-financeiro-adimplentes").textContent = `0 Adimplentes | 0 Inadimplentes`;
            document.getElementById("chart-documentacao-regular").textContent = `0 Regulares | 0 Irregulares`;
            document.getElementById("chart-modalidade-semi").textContent = `0 Semi | 0 Online`;
            document.getElementById("chart-evasao-trancada").textContent = `0 Evasão | T:0 C:0`;
            // Não zera kpi-meta-mat e kpi-meta-remat pois eles vêm da configuração
            document.getElementById("chart-status-ativos").textContent = `N/A Status`;
        }

        // 4. Atualizar KPIs principais (sempre atualiza, mesmo que dados seja null)
        document.getElementById("kpi-ativos").textContent = totalAtivos;
        document.getElementById("kpi-progresso").textContent = `${progresso}%`;
        
        // 5. Atualiza a barra de progresso visual (usando o elemento específico)
        progressoBar.style.width = `${Math.min(progresso, 100)}%`;

        console.log(`Dados carregados na tela. Ativos: ${totalAtivos}, Progresso: ${progresso}%`);
    }

    // === 7. LÓGICA DO MODAL DE DADOS DIÁRIOS ===
    const dataModal = document.getElementById("dataModal");
    const openDataBtn = document.getElementById("openModalBtn");
    const dataCloseBtn = document.getElementsByClassName("data-close-btn")[0];
    const dataForm = document.getElementById("dataForm");
    const inputDataDisplay = document.getElementById("input-data-display");
    const inputDataFirestore = document.getElementById("input-data-firestore");

    openDataBtn.onclick = function() {
        if (!isAuthReady) {
             showNotification("Aguarde a inicialização da autenticação (Firebase).", 'error');
             return;
        }

        const today = new Date();
        // Preenche a data no formato de exibição (DD/MM/YYYY)
        inputDataDisplay.value = formatDateDisplay(today);
        // Preenche a data no formato de ID (YYYY-MM-DD)
        inputDataFirestore.value = formatDateID(today);
        
        dataModal.style.display = "block";
        document.getElementById('saveDataBtn').textContent = 'Salvar Registro';
        document.getElementById('saveDataBtn').disabled = false;
        
        // Limpa os campos do formulário ao abrir (exceto datas)
        dataForm.reset(); 
    }

    dataCloseBtn.onclick = function() { dataModal.style.display = "none"; }

    dataForm.onsubmit = async function(event) {
        event.preventDefault();
        
        if (!isAuthReady || !userId) {
            showNotification("Aguarde a inicialização do Firebase.", 'error');
            return;
        }

        const dataId = inputDataFirestore.value; // YYYY-MM-DD
        const dataDisplay = inputDataDisplay.value; // DD/MM/YYYY

        const submitBtn = document.getElementById('saveDataBtn');
        submitBtn.textContent = 'Salvando...';
        submitBtn.disabled = true;

        // Captura de dados do formulário (Garantir que sejam números inteiros)
        const getFormValue = (id) => parseInt(document.getElementById(id).value) || 0;

        const formData = {
            data_id: dataId,
            data_display: dataDisplay,
            timestamp: Date.now(), 
            adimplente: getFormValue("input-adimplente"),
            inadimplente: getFormValue("input-inadimplente"),
            ativa: getFormValue("input-ativa"),
            formando: getFormValue("input-formando"),
            doc_regular: getFormValue("input-doc-reg"),
            doc_irre: getFormValue("input-doc-irre"),
            ath_calouros: getFormValue("input-ath-calouros"),
            ath_veterano: getFormValue("input-ath-veterano"),
            calouro_ext: getFormValue("input-calouro-ext"),
            semipresencial: getFormValue("input-semipresencial"),
            online_100: getFormValue("input-100-online"),
            trancada: getFormValue("input-trancada"),
            cancelada: getFormValue("input-cancelada"),
            nao_efet_mat: getFormValue("input-nao-efet")
        };

        try {
            const docRef = doc(db, DAILY_COLLECTION_PATH(userId), dataId);
            await setDoc(docRef, formData);
            
            showNotification(`Registro de ${dataDisplay} salvo com sucesso no Firestore!`, 'success');
            dataModal.style.display = "none";

        } catch (error) {
            console.error('Erro ao salvar o registro diário:', error);
            const errorMessage = error.code && error.code === 'permission-denied' ? 
                                 'ERRO: Permissão negada. Verifique suas Regras de Segurança.' : 
                                 'ERRO: Não foi possível salvar o registro no banco de dados. Verifique as regras de segurança.';
            showNotification(errorMessage, 'error');
        } finally {
            submitBtn.textContent = 'Salvar Registro';
            submitBtn.disabled = false;
        }
    }


    // === 8. LÓGICA DO MODAL DE CONFIGURAÇÃO (METAS) ===
    const configModal = document.getElementById("configModal");
    const openConfigBtn = document.getElementById("openConfigBtn");
    const configCloseBtn = document.getElementsByClassName("config-close-btn")[0];
    const configForm = document.getElementById("configForm");

    // Recalcula o total quando os campos de matrícula/rematrícula mudam
    document.getElementById("config-meta-mat").oninput = 
    document.getElementById("config-meta-remat").oninput = function() {
        const mat = parseInt(document.getElementById("config-meta-mat").value) || 0;
        const remat = parseInt(document.getElementById("config-meta-remat").value) || 0;
        document.getElementById("config-meta-total").value = mat + remat;
    };

    openConfigBtn.onclick = function() {
        if (!isAuthReady) {
             showNotification("Aguarde a inicialização da autenticação (Firebase).", 'error');
             return;
        }

        // Preenche o formulário com os valores atuais antes de abrir
        document.getElementById("config-meta-mat").value = metasConfig.meta_matricula;
        document.getElementById("config-meta-remat").value = metasConfig.meta_rematricula;
        document.getElementById("config-meta-total").value = metasConfig.meta_total;
        configModal.style.display = "block"; 
    }
    configCloseBtn.onclick = function() { configModal.style.display = "none"; }

    configForm.onsubmit = async function(event) {
        event.preventDefault();
        
        if (!isAuthReady || !userId) {
            showNotification("Aguarde a inicialização do Firebase.", 'error');
            return;
        }

        const newMat = parseInt(document.getElementById("config-meta-mat").value) || 0;
        const newRemat = parseInt(document.getElementById("config-meta-remat").value) || 0;
        const newTotal = newMat + newRemat;

        const configData = {
            meta_matricula: newMat,
            meta_rematricula: newRemat,
            meta_total: newTotal
        };

        const submitBtn = document.getElementById('saveConfigBtn');
        submitBtn.textContent = 'Salvando...';
        submitBtn.disabled = true;

        try {
            const docRef = doc(db, CONFIG_DOC_PATH(userId));
            // O setDoc aqui acionará o Listener de Metas, que irá recalcular tudo na tela.
            await setDoc(docRef, configData);

            showNotification(`Metas atualizadas com sucesso! Total: ${newTotal}.`, 'success');
            configModal.style.display = "none";
        } catch (error) {
            console.error('Erro ao salvar a configuração:', error);
            const errorMessage = error.code && error.code === 'permission-denied' ? 
                                 'ERRO: Permissão negada. Verifique suas Regras de Segurança.' : 
                                 'ERRO: Não foi possível salvar as configurações. Verifique as regras de segurança.';
            showNotification(errorMessage, 'error');
        } finally {
            submitBtn.textContent = 'Salvar Configuração';
            submitBtn.disabled = false;
        }
    }


    // === 9. LÓGICA DO FILTRO DE DATA (BUSCA HISTÓRICA) ===
    const btnFiltrar = document.getElementById("btn-filtrar");
    const inputFiltroData = document.getElementById("data-filtro");

    btnFiltrar.onclick = async function() {
        const dataSelecionada = inputFiltroData.value; // YYYY-MM-DD
        
        if (!dataSelecionada) {
            showNotification("Por favor, selecione uma data para filtrar a visualização.", 'info');
            return;
        }
        
        if (!isAuthReady || !userId) {
            showNotification("Aguarde a inicialização do Firebase.", 'error');
            return;
        }

        // Desabilita botão enquanto busca
        btnFiltrar.disabled = true;
        btnFiltrar.textContent = 'Buscando...';

        try {
            const docRef = doc(db, DAILY_COLLECTION_PATH(userId), dataSelecionada);
            const snapshot = await getDoc(docRef);

            if (snapshot.exists()) {
                const dadosFiltrados = snapshot.data();
                // O filtro carrega os dados filtrados. O listener do último registro continua rodando em background.
                carregarDadosNaTela(dadosFiltrados); 
                showNotification(`Dados do dia ${dadosFiltrados.data_display} carregados com sucesso.`, 'success');
            } else {
                carregarDadosNaTela(null); // Limpa a tela
                document.getElementById("chart-data-registro").textContent = 'Data: Nenhum Registro Encontrado';
                showNotification(`Nenhum registro encontrado para a data: ${dataSelecionada}.`, 'info');
            }
        } catch (error) {
            console.error('Erro ao buscar registro por data:', error);
            const errorMessage = error.code && error.code === 'permission-denied' ? 
                                 'ERRO: Permissão negada ao buscar histórico.' : 
                                 'Erro ao buscar dados históricos. Verifique o console.';
            showNotification(errorMessage, 'error');
        } finally {
            btnFiltrar.disabled = false;
            btnFiltrar.textContent = 'Filtrar';
        }
    }

    // === 10. FECHAR MODAIS E INICIAR APP ===
    window.onclick = function(event) {
        if (event.target == dataModal) {
            dataModal.style.display = "none";
        }
        if (event.target == configModal) {
            configModal.style.display = "none";
        }
    }

    // Iniciar o Firebase após o carregamento completo da janela.
    window.onload = initializeFirebase;

</script>

</body>

</html>
